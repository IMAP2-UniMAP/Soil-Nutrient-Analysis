<!DOCTYPE html>
<html>
<head>
    <title>Soil Nutrient Analysis</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet & Bootstrap CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        #map { height: 500px; }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        #timestampText {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9f7ef;
            border: 1px solid #28a745;
            border-radius: 8px;
            color: #155724;
            font-weight: bold;
        }
        .page-title {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="container py-4 bg-white text-dark">
    <h2 class="page-title">Soil Nutrient Analysis</h2>

    <div id="map"></div>

    <!-- Timestamp Display -->
    <div id="timestampText">
        üïí Last update: --
    </div>

    <!-- Buttons -->
    <div class="mt-3">
        <button id="recordBtn" class="btn btn-primary">üìç Record Point</button>
        <button id="clearBtn" class="btn btn-danger">üóëÔ∏è Clear All Points</button>
    </div>

    <!-- Table of Recorded Points with Soil Data -->
    <div class="table-container">
        <table class="table table-bordered table-striped">
            <thead class="table-light">
                <tr>
                    <th>No</th>
                    <th>Time (MY)</th>
                    <th>Location</th>
                    <th>Moist (%)</th>
                    <th>pH</th>
                    <th>N (mg/kg)</th>
                    <th>P (mg/kg)</th>
                    <th>K (mg/kg)</th>
                    <th>Air Temp (¬∞C)</th>
                </tr>
            </thead>
            <tbody id="recordTableBody"></tbody>
        </table>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        const CHANNEL_ID = 2995665;
        const API_KEY = 'GJVNL72R9QETDKHY';
        const FETCH_INTERVAL = 5000;

        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 18
        });

        const map = L.map('map', {
            center: [0, 0],
            zoom: 18,
            layers: [satelliteLayer]
        });

        const baseLayers = {
            "üó∫ Street Map": streetLayer,
            "üõ† Satellite": satelliteLayer
        };

        L.control.layers(baseLayers).addTo(map);

        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        let currentMarker = null;
        let recordedPoints = [];
        let polyline = L.polyline([], { color: 'red' }).addTo(map);

        async function fetchThingSpeakData() {
            const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${API_KEY}&results=1`;
            const response = await fetch(url);
            const data = await response.json();
            const feed = data.feeds[0];
            if (!feed) return;

            const lat = parseFloat(feed.field1);
            const lng = parseFloat(feed.field2);
            const moisture = parseFloat(feed.field3);
            const n = parseInt(feed.field4);
            const p = parseInt(feed.field5);
            const k = parseInt(feed.field6);
            const ph = parseFloat(feed.field7);
            const temp = parseFloat(feed.field8);

            const utcTime = new Date(feed.created_at);
            const malaysiaTimeStr = new Intl.DateTimeFormat('en-MY', {
                timeZone: 'Asia/Kuala_Lumpur', dateStyle: 'short', timeStyle: 'medium'
            }).format(utcTime);

            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            currentMarker = L.marker([lat, lng], { icon: greenIcon }).addTo(map);
            currentMarker.bindPopup(`
				üü¢ <strong>Updated Location</strong><br>
				üìç <b>Location:</b> ${lat.toFixed(5)}, ${lng.toFixed(5)}<br>
				üíß <b>Moisture:</b> ${moisture.toFixed(1)} %<br>
				üå°Ô∏è <b>Air Temp:</b> ${temp.toFixed(1)} ¬∞C<br>
				üß™ <b>pH:</b> ${ph.toFixed(1)}<br>
				üß¨ <b>N:</b> ${n} mg/kg<br>
				üß¨ <b>P:</b> ${p} mg/kg<br>
				üß¨ <b>K:</b> ${k} mg/kg<br>
				‚è∞ <b>Time:</b> ${malaysiaTimeStr}
			`);

            map.setView([lat, lng], map.getZoom());

            document.getElementById('timestampText').innerText = `üïí Last update: ${malaysiaTimeStr}`;

            window.currentData = {
                lat, lng, moisture, ph, n, p, k, temp, malaysiaTimeStr
            };
        }

        document.getElementById('recordBtn').addEventListener('click', () => {
            const d = window.currentData;
            if (d && d.lat && d.lng) {
                recordedPoints.push([d.lat, d.lng]);
                polyline.setLatLngs(recordedPoints);

                L.marker([d.lat, d.lng], { icon: blueIcon })
                    .addTo(map)
                    .bindPopup(`
						üîµ <strong>Recorded Point</strong><br>
						üìç <b>Location:</b> ${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}<br>
						üíß <b>Moisture:</b> ${d.moisture.toFixed(1)} %<br>
						üå°Ô∏è <b>Air Temp:</b> ${d.temp.toFixed(1)} ¬∞C<br>
						üß™ <b>pH:</b> ${d.ph.toFixed(1)}<br>
						üß¨ <b>N:</b> ${d.n} mg/kg<br>
						üß¨ <b>P:</b> ${d.p} mg/kg<br>
						üß¨ <b>K:</b> ${d.k} mg/kg<br>
						‚è∞ <b>Time:</b> ${d.malaysiaTimeStr}
					`);

                const row = `<tr>
                    <td>${recordedPoints.length}</td>
                    <td>${d.malaysiaTimeStr}</td>
                    <td>${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}</td>
                    <td>${d.moisture.toFixed(1)}</td>
                    <td>${d.ph.toFixed(1)}</td>
                    <td>${d.n}</td>
                    <td>${d.p}</td>
                    <td>${d.k}</td>
                    <td>${d.temp.toFixed(1)}</td>
                </tr>`;
                document.getElementById('recordTableBody').insertAdjacentHTML('beforeend', row);
            }
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            recordedPoints = [];
            polyline.setLatLngs([]);
            document.getElementById('recordTableBody').innerHTML = '';
        });

        fetchThingSpeakData();
        setInterval(fetchThingSpeakData, FETCH_INTERVAL);
    </script>
</body>
</html>
